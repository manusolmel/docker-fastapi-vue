image: docker:latest

services:
  - name: docker:dind
    alias: docker
    entrypoint: ["dockerd-entrypoint.sh", "--tls=false", "--ipv6=false", "--dns=1.1.1.1", "--dns=8.8.8.8"]

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

  DOCKER_BUILDKIT: "1"

stages:
  - test
  - build
  - deploy

# Tests 
check-docker:
  stage: test
  tags: [k8s]
  script:
    - echo "Verificando Docker Daemon..."
    - docker info
    - echo "Runner listo para crear contenedores."

tls-smoke:
  stage: test
  tags: [k8s]
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
      entrypoint: ["dockerd-entrypoint.sh", "--tls=false", "--ipv6=false", "--dns=1.1.1.1", "--dns=8.8.8.8"]
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  script:
    - apk add --no-cache ca-certificates openssl curl bind-tools
    - date -Is
    - echo "DNS:"; nslookup registry-1.docker.io || true
    - echo "TLS curl:"; curl -svI https://registry-1.docker.io/v2/ 2>&1 | tail -n 30
    - echo "TLS openssl:"
    - echo | openssl s_client -connect registry-1.docker.io:443 -servername registry-1.docker.io -tls1_2 2>/dev/null | head -n 25

# Build & Push 
.build_template:
  stage: build
  tags: [k8s]
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - echo "Building $COMPONENT from ./$FOLDER"
    - docker build -t "$CI_REGISTRY_IMAGE/$COMPONENT:$CI_COMMIT_SHA" "./$FOLDER"
    - docker push "$CI_REGISTRY_IMAGE/$COMPONENT:$CI_COMMIT_SHA"
    - docker tag "$CI_REGISTRY_IMAGE/$COMPONENT:$CI_COMMIT_SHA" "$CI_REGISTRY_IMAGE/$COMPONENT:latest"
    - docker push "$CI_REGISTRY_IMAGE/$COMPONENT:latest"

build_fastapi:
  extends: .build_template
  variables:
    COMPONENT: "fastapi"
    FOLDER: "fastapi"

build_vue:
  extends: .build_template
  variables:
    COMPONENT: "vue"
    FOLDER: "vue-project"

build_nginx:
  extends: .build_template
  variables:
    COMPONENT: "nginx"
    FOLDER: "nginx"

# Deploy (GitLab Agent)
deploy_prod:
  stage: deploy
  tags: [k8s]
  image:
    name: bitnami/kubectl:latest
    entrypoint: [""]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - kubectl config get-contexts

    - kubectl config use-context "manusolmel/docker-fastapi-vue:backend-frontend-project"

    # Aplicamos manifests 
    - kubectl apply -f k8s/

    # Pin de im√°genes por commit
    - kubectl -n fastapi-vue-test set image deploy/fastapi fastapi="$CI_REGISTRY_IMAGE/fastapi:$CI_COMMIT_SHA"
    - kubectl -n fastapi-vue-test set image deploy/vue vue="$CI_REGISTRY_IMAGE/vue:$CI_COMMIT_SHA"
    - kubectl -n fastapi-vue-test set image deploy/nginx nginx="$CI_REGISTRY_IMAGE/nginx:$CI_COMMIT_SHA"

    # Espera rollout
    - kubectl -n fastapi-vue-test rollout status deploy/fastapi --timeout=180s
    - kubectl -n fastapi-vue-test rollout status deploy/nginx --timeout=180s
